# docker-compose file
#
# project: crdm-tools
# author: b.briotribeyre@nhs.net

version: "3"

services:
  omop_es:
    env_file: "./omop_es/.env"
    platform: linux/amd64
    environment:
      - "HTTP_PROXY=${PROXY}"
      - "HTTPS_PROXY=${PROXY}"
      - "OMOP_ES_SETTINGS_ID=${SETTINGS_ID}"
      - "OMOP_ES_BATCHED=${BATCHED}"
      - "OMOP_ES_START_BATCH=${START_BATCH}"
      - "OMOP_ES_EXTRACT_DT=${EXTRACT_DT}"
      - "OMOP_ES_ZIP_OUTPUT=${ZIP_OUTPUT}"
      - "GIT_USERNAME=${GIT_USERNAME}"
      - "GIT_PASSWORD=${GIT_PASSWORD}"
    volumes:
      - "./omop_es/app:/app"
      - "./omop_es/local:/share/local"
      - "sharefs6-criudata:/sharefs6/criudata/Live"
      - "sharefs7-crdm:/sharefs7/crdm/Shared"
    build:
      context: "./omop_es"
      args:
        - "FTP_PROXY=${PROXY}"
        - "HTTP_PROXY=${PROXY}"
        - "HTTPS_PROXY=${PROXY}"

  omop-cascade:
    env_file: "./omop-cascade/.env"
    platform: linux/amd64
    environment:
      - "HTTP_PROXY=${PROXY}"
      - "HTTPS_PROXY=${PROXY}"
      - "CRDM_ID=${ID}"
      - "GIT_USERNAME=${GIT_USERNAME}"
      - "GIT_PASSWORD=${GIT_PASSWORD}"
    volumes:
      - "./omop-cascade/app:/app"
      - "./omop-cascade/local:/share/local"
      - "sharefs6-criudata:/sharefs6/criudata/Live"
      - "sharefs7-crdm:/sharefs7/crdm/Shared"
    build:
      context: "./omop-cascade"
      args:
        - "FTP_PROXY=${PROXY}"
        - "HTTP_PROXY=${PROXY}"
        - "HTTPS_PROXY=${PROXY}"
    network_mode: host

volumes:
  sharefs6-criudata:
    driver: "local"
    driver_opts:
      type: "cifs"
      device: "${SHAREFS6_CRIUDATA}"
      o: "user=${USER_UID},domain=${USER_DOMAIN},password=${USER_PWD}"

  sharefs7-crdm:
    driver: "local"
    driver_opts:
      type: "cifs"
      device: "${SHAREFS7_CRDM}"
      o: "user=${USER_UID},domain=${USER_DOMAIN},password=${USER_PWD}"
